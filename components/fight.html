<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIGHT!</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/fight.css">
    <!-- Add sound.js -->
    <script src="../js/sound.js"></script>
</head>
<body>
    <!-- Press Any Key Overlay -->
    <div class="press-key-overlay" id="pressKeyOverlay">
        <div class="press-key-text">PRESS ANY KEY TO BEGIN</div>
    </div>

    <!-- Character Introduction Elements -->
    <div class="character-intro intro-left" id="player1Intro">
        <div class="fighter-image"></div>
        <div class="character-name"></div>
    </div>
    <div class="character-intro intro-right" id="player2Intro">
        <div class="fighter-image"></div>
        <div class="character-name"></div>
    </div>

    <!-- Round Announcement -->
    <div class="round-announcement" id="roundAnnouncement"></div>

    <!-- Announcer Audio Elements -->
    <audio id="announcerInit" src="../assests/audio/announcer/announcer_initialize.mp3" preload="auto" muted></audio>
    <audio id="leftCurseor" src="../assests/audio/announcer/Left_Curse-or.mp3" preload="auto" muted></audio>
    <audio id="leftReign" src="../assests/audio/announcer/Left_Reign.mp3" preload="auto" muted></audio>
    <audio id="rightCurseor" src="../assests/audio/announcer/Right_Curse-or.mp3" preload="auto" muted></audio>
    <audio id="rightReign" src="../assests/audio/announcer/Right_Reign.mp3" preload="auto" muted></audio>
    <audio id="fightBegin" src="../assests/audio/announcer/fight_begin.mp3" preload="auto" muted></audio>
    <audio id="introCheer" src="../assests/audio/ambience/cheer2_charecters.mp3" preload="auto"></audio>

    <!-- Background Audio Elements -->
    <audio id="ambienceAudio" src="../assests/audio/ambience/cheer1.mp3" preload="auto" loop></audio>
    <audio id="mapMusic" preload="auto" loop></audio>

    <div id="fightScreen" class="intro-phase">
        <div id="fightHeader">
            <div class="timer">60</div>
        </div>
        
        <!-- Health bars at the top -->
        <div class="health-bars">
            <div id="player1-health" class="player-health">
                <div class="player-health-name">PLAYER 1</div>
                <div class="health-bar-container">
                    <div class="health-bar" style="width: 100%;">100%</div>
                </div>
                <div class="main-stamina-container">
                    <div class="main-stamina-bar" style="width: 100%;"></div>
                </div>
            </div>
            
            <div id="player2-health" class="player-health">
                <div class="player-health-name">PLAYER 2</div>
                <div class="health-bar-container">
                    <div class="health-bar" style="width: 100%;">100%</div>
                </div>
                <div class="main-stamina-container">
                    <div class="main-stamina-bar" style="width: 100%;"></div>
                </div>
            </div>
        </div>
        
        <!-- Bar Background -->
        <div class="bar-background"></div>
        
        <div id="fightArena">
            <!-- Background container will be added here by JavaScript -->
            <div id="player1" class="fighter">
                <div class="fighter-image"></div>
            </div>
            
            <div id="fightStatus">
                <div id="vsText">VS</div>
            </div>
            
            <div id="player2" class="fighter">
                <div class="fighter-image"></div>
            </div>
        </div>
        
        <div id="controls">
            <div class="control-instructions">
                <div class="player1-controls">
                    <h3>PLAYER 1</h3>
                    <div class="controls-container">
                        <div class="basic-controls">
                            <p>W - Jump</p>
                            <p>A - Move Left</p>
                            <p>D - Move Right</p>
                            <p>S - Guard</p>
                            <p>F - Punch</p>
                            <p>G - Kick</p>
                            <p class="special-move">Shift + A/D - Shadow Shift</p>
                        </div>
                        <div class="move-description">
                            <p>Master the art of deception!</p>
                            <ul>
                                <li>Creates a phantom clone</li>
                                <li>Perfect for mind games</li>
                                <li>Heal 30% on clone hit</li>
                                <li>10s cooldown</li>
                                <li>Costs 30% stamina</li>
                            </ul>
                            <p class="tip">TIP: Use to bait attacks!</p>
                        </div>
                    </div>
                </div>
                
                <div class="player2-controls">
                    <h3>PLAYER 2</h3>
                    <div class="controls-container">
                        <div class="basic-controls">
                            <p>↑ - Jump</p>
                            <p>← - Move Left</p>
                            <p>→ - Move Right</p>
                            <p>↓ - Guard</p>
                            <p>K - Punch</p>
                            <p>L - Kick</p>
                            <p class="special-move">Ctrl + ←/→ - Shadow Shift</p>
                        </div>
                        <div class="move-description">
                            <p>Unleash the power of illusion!</p>
                            <ul>
                                <li>Creates a phantom clone</li>
                                <li>Perfect for mind games</li>
                                <li>Heal 30% on clone hit</li>
                                <li>10s cooldown</li>
                                <li>Costs 30% stamina</li>
                            </ul>
                            <p class="tip">TIP: Bait and counter!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="button-container">
                <button id="settingsButton" class="settings-button"
                        onmousedown="SoundManager.playClickSound(); openSettings();"
                        onmouseover="SoundManager.playHoverSound()">
                    SETTINGS
                </button>
                <button id="backButton" class="back-button" 
                        onmousedown="SoundManager.playClickSound(); setTimeout(function() { goToMapSelection(); }, 300);" 
                        onmouseover="SoundManager.playHoverSound()">
                    BACK
                </button>
                <button id="changeCharactersButton" 
                        onmousedown="SoundManager.playClickSound(); setTimeout(function() { changeCharacters(); }, 300);" 
                        onmouseover="SoundManager.playHoverSound()">
                    CHANGE FIGHTERS
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sound effects -->
    <audio id="hitSound" src="../assets/sounds/hit.mp3" preload="auto"></audio>
    <audio id="victorySound" src="../assets/sounds/victory.mp3" preload="auto"></audio>
    
    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="settings-overlay" style="display: none;">
        <div class="settings-content">
            <h2>GAME PAUSED</h2>
            <div class="settings-buttons">
                <button id="continueButton" onclick="closeSettings()">CONTINUE</button>
                <button id="audioSettingsButton" onclick="openAudioSettings()">AUDIO SETTINGS</button>
                <button id="restartButton" onclick="restartGame()">RESTART</button>
                <button id="settingsChangeMapButton" onclick="goToMapSelection()">CHANGE MAP</button>
                <button id="settingsChangeFightersButton" onclick="changeCharacters()">CHANGE FIGHTERS</button>
                <button id="settingsMainMenuButton" onclick="goToMainMenu()">MAIN MENU</button>
            </div>
        </div>
    </div>

    <!-- Audio Settings Overlay -->
    <div id="audioSettingsOverlay" class="settings-overlay" style="display: none;">
        <div class="settings-content audio-settings">
            <h2>AUDIO SETTINGS</h2>
            <div class="volume-controls">
                <div class="volume-control">
                    <label for="bgmVolume">Background Music</label>
                    <input type="range" id="bgmVolume" min="0" max="100" value="40" 
                           oninput="updateVolume('bgm', this.value)">
                    <span class="volume-value">40%</span>
                </div>
                <div class="volume-control">
                    <label for="sfxVolume">Sound Effects</label>
                    <input type="range" id="sfxVolume" min="0" max="100" value="60" 
                           oninput="updateVolume('sfx', this.value)">
                    <span class="volume-value">60%</span>
                </div>
                <div class="volume-control">
                    <label for="announcerVolume">Announcer</label>
                    <input type="range" id="announcerVolume" min="0" max="100" value="70" 
                           oninput="updateVolume('announcer', this.value)">
                    <span class="volume-value">70%</span>
                </div>
                <div class="volume-control">
                    <label for="playerSfxVolume">Player Effects</label>
                    <input type="range" id="playerSfxVolume" min="0" max="100" value="60" 
                           oninput="updateVolume('playerSfx', this.value)">
                    <span class="volume-value">60%</span>
                </div>
            </div>
            <button id="backToSettingsButton" onclick="closeAudioSettings()" class="back-to-settings">
                BACK
            </button>
        </div>
    </div>

    <!-- Victory Audio Elements -->
    <audio id="victoryMusic" src="../assests/audio/announcer/victory.mp3" preload="auto"></audio>
    <audio id="victoryCheer" src="../assests/audio/ambience/cheer2_charecters.mp3" preload="auto"></audio>

    <style>
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-content {
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 10px;
            border: 2px solid #ff4444;
            text-align: center;
        }

        .settings-content h2 {
            color: #fff;
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #fff,
                         0 0 30px #ff0000,
                         0 0 40px #ff0000;
        }

        .settings-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .settings-buttons button {
            padding: 15px 30px;
            font-size: 24px;
            background: linear-gradient(to bottom, #ff3333, #cc0000);
            color: white;
            border: 2px solid #ff4444;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 300px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .settings-buttons button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .settings-button {
            padding: 10px 20px;
            font-size: 18px;
            background: linear-gradient(to bottom, #ff3333, #cc0000);
            color: white;
            border: 2px solid #ff4444;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .settings-button:hover {
            transform: scale(1.05);
        }

        .audio-settings {
            min-width: 500px;
        }

        .volume-controls {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 30px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .volume-control label {
            min-width: 150px;
            text-align: right;
            font-size: 20px;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .volume-control input[type="range"] {
            flex-grow: 1;
            height: 10px;
            border-radius: 5px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff4444;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #ff6666;
        }

        .volume-control .volume-value {
            min-width: 50px;
            text-align: left;
            font-size: 18px;
        }

        .back-to-settings {
            padding: 15px 30px;
            font-size: 24px;
            background: linear-gradient(to bottom, #ff3333, #cc0000);
            color: white;
            border: 2px solid #ff4444;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .back-to-settings:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .special-move {
            color: #ff3333;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 20px;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .move-description {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #ff4444;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .move-description p {
            margin: 5px 0;
            color: #fff;
        }

        .move-description ul {
            list-style-type: none;
            padding-left: 15px;
            margin: 10px 0;
        }

        .move-description li {
            color: #ddd;
            margin: 5px 0;
            position: relative;
            padding-left: 15px;
        }

        .move-description li:before {
            content: "•";
            color: #ff4444;
            position: absolute;
            left: 0;
        }

        .tip {
            color: #ffcc00 !important;
            font-style: italic;
            font-weight: bold;
            margin-top: 10px !important;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }

        .control-instructions {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            gap: 20px;
            max-height: 200px;
        }

        .player1-controls, .player2-controls {
            flex: 1;
            max-width: 500px;
        }

        .controls-container {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 15px;
            align-items: start;
        }

        .basic-controls {
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ff4444;
        }

        .basic-controls p {
            margin: 3px 0;
            color: #fff;
        }

        .move-description {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #ff4444;
            border-radius: 5px;
            padding: 8px;
            font-size: 0.9em;
        }

        .move-description p {
            margin: 3px 0;
            color: #fff;
        }

        .move-description ul {
            list-style-type: none;
            padding-left: 15px;
            margin: 5px 0;
        }

        .move-description li {
            color: #ddd;
            margin: 3px 0;
            position: relative;
            padding-left: 15px;
            font-size: 0.9em;
        }

        .move-description li:before {
            content: "•";
            color: #ff4444;
            position: absolute;
            left: 0;
        }

        .special-move {
            color: #ff3333;
            font-weight: bold;
            font-size: 1em;
            margin-top: 5px;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .tip {
            color: #ffcc00 !important;
            font-style: italic;
            font-weight: bold;
            margin-top: 5px !important;
            font-size: 0.9em;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }

        h3 {
            margin: 0 0 10px 0;
            text-align: center;
        }

        .bar-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-image: url('../assests/maps/bar.gif');
            background-size: cover;
       
            background-repeat: no-repeat;
            z-index: -1000;
            filter: brightness(50%);
            margin: 0;
            padding: 0;
        }

        #fightArena {
            position: relative;
            z-index: 2;
            margin-top: 0;
            padding-top: 0;
        }

        #fightScreen {
            position: relative;
            padding: 0;
            margin: 0;
        }

        .health-bars {
            position: relative;
            z-index: 3;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        #fightHeader {
            position: relative;
            z-index: 3;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            will-change: transform, opacity;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .winner-announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            color: #fff;
            text-shadow: 0 0 20px #fff,
                         0 0 30px #ff0000,
                         0 0 40px #ff0000;
            z-index: 999;
            animation: pulse 2s infinite;
        }
    </style>

    <script>
        // Initialize audio when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize audio system
            function initAudio() {
                console.log('Initializing audio for fight screen...');
                
                // Initialize ambience and map music
                const ambienceAudio = document.getElementById('ambienceAudio');
                const mapMusic = document.getElementById('mapMusic');
                
                // Set volumes
                ambienceAudio.volume = 0.3;  // Crowd cheering at 30% volume
                mapMusic.volume = 0.4;       // Background music at 40% volume
                
                // Select random map music track and prepare it (but don't play yet)
                const mapMusicTracks = [
                    '../assests/audio/map_music/map_music_1.mp3',
                    '../assests/audio/map_music/map_music_2.mp3',
                    '../assests/audio/map_music/map_music_3.mp3',
                    '../assests/audio/map_music/map_music_4.mp3'
                ];
                const randomTrack = mapMusicTracks[Math.floor(Math.random() * mapMusicTracks.length)];
                mapMusic.src = randomTrack;
                
                // Only start the crowd ambience
                ambienceAudio.play().catch(error => {
                    console.error('Error playing ambience:', error);
                });
                
                // If background music was already initialized by SoundManager, stop it
                if (window.SoundManager) {
                    window.SoundManager.stopBackgroundMusic();
                }
            }
            
            // Set up event listeners for user interaction to unlock audio
            document.addEventListener('click', function() {
                initAudio();
            }, { once: true });
            
            document.addEventListener('keydown', function() {
                initAudio();
            }, { once: true });
            
            // Also try to play after a short delay
            setTimeout(function() {
                initAudio();
            }, 1000);
        });
        
        // Function to debug images
        function debugImages() {
            console.log('Debugging images...');
            
            // Get player elements
            const player1Element = document.getElementById('player1');
            const player2Element = document.getElementById('player2');
            const player1Image = document.querySelector('#player1 .fighter-image');
            const player2Image = document.querySelector('#player2 .fighter-image');
            
            // Log image properties
            console.log('Player 1 image properties:', {
                backgroundImage: player1Image.style.backgroundImage,
                backgroundSize: player1Image.style.backgroundSize,
                backgroundPosition: player1Image.style.backgroundPosition,
                backgroundRepeat: player1Image.style.backgroundRepeat,
                backgroundColor: player1Image.style.backgroundColor,
                width: player1Image.style.width,
                height: player1Image.style.height,
                transform: player1Image.style.transform,
                classes: player1Element.className
            });
            
            console.log('Player 2 image properties:', {
                backgroundImage: player2Image.style.backgroundImage,
                backgroundSize: player2Image.style.backgroundSize,
                backgroundPosition: player2Image.style.backgroundPosition,
                backgroundRepeat: player2Image.style.backgroundRepeat,
                backgroundColor: player2Image.style.backgroundColor,
                width: player2Image.style.width,
                height: player2Image.style.height,
                transform: player2Image.style.transform,
                classes: player2Element.className
            });
            
            // Try to fix Player 2 image if it's not showing
            if (!player2Image.style.backgroundImage || player2Image.style.backgroundImage === 'none') {
                const player2Id = sessionStorage.getItem('player2Character') || 'subzero';
                let player2ImagePath;
                
                if (player2Id === 'scorpion') {
                    player2ImagePath = '../assests/players/character_1/Right_idle.gif';
                } else if (player2Id === 'subzero') {
                    player2ImagePath = '../assests/players/character_2/2_Right_idle.gif';
                } else {
                    player2ImagePath = '../assests/players/character_2/2_Right_idle.gif';
                }
                
                console.log('Fixing Player 2 image with path:', player2ImagePath);
                
                player2Image.style.backgroundImage = `url(${player2ImagePath})`;
                player2Image.style.backgroundSize = 'contain';
                player2Image.style.backgroundPosition = 'center bottom';
                player2Image.style.backgroundRepeat = 'no-repeat';
                player2Image.style.backgroundColor = 'transparent';
            }
            
            // Remove any facing classes that might interfere
            player1Element.classList.remove('facing-left', 'facing-right');
            player2Element.classList.remove('facing-left', 'facing-right');
            
            // Get player positions to determine orientation
            const player1Position = parseInt(player1Element.style.left) || 200;
            const player2Position = parseInt(player2Element.style.left) || 800;
            const player1IsOnRight = player1Position > player2Position;
            
            console.log('Player positions:', player1Position, player2Position, 'P1 on right:', player1IsOnRight);
            
            // Set the correct orientation based on relative positions
            if (player1IsOnRight) {
                // Player 1 is on the right, should face left (towards player 2)
                player1Image.style.transform = 'scaleX(-1)';
                
                // Player 2 is on the left, should face right (towards player 1)
                const player2Id = sessionStorage.getItem('player2Character') || 'subzero';
                if (player2Id === 'subzero') {
                    player2Image.style.transform = 'scaleX(1) scale(0.85)';
                } else {
                    player2Image.style.transform = 'scaleX(1)';
                }
            } else {
                // Player 1 is on the left, should face right (towards player 2)
                player1Image.style.transform = 'scaleX(1)';
                
                // Player 2 is on the right, should face left (towards player 1)
                const player2Id = sessionStorage.getItem('player2Character') || 'subzero';
                if (player2Id === 'subzero') {
                    player2Image.style.transform = 'scaleX(-1) scale(0.85)';
                } else {
                    player2Image.style.transform = 'scaleX(-1)';
                }
            }
            
            // Show alert with debug info
            alert('Image debug info logged to console. Check the console for details. Orientation and sizing have been fixed based on player positions.');
        }
        
        // Function to show session storage data
        function showSessionStorage() {
            const player1Character = sessionStorage.getItem('player1Character');
            const player2Character = sessionStorage.getItem('player2Character');
            const selectedMap = sessionStorage.getItem('selectedMap');
            
            alert(`Current session storage:
Player 1: ${player1Character || 'Not set'}
Player 2: ${player2Character || 'Not set'}
Map: ${selectedMap || 'Not set'}`);
        }

        // Function to change characters
        function changeCharacters() {
            console.log('Changing characters...');
            
            // Play click sound and navigate after it completes
            if (window.SoundManager) {
                // Create a new audio element specifically for this navigation
                const clickSound = new Audio('../assests/audio/button_click.mp3');
                clickSound.volume = 0.5;
                
                // When the sound can play, play it and set up navigation
                clickSound.addEventListener('canplaythrough', function() {
                    console.log('Navigation sound loaded, playing...');
                    
                    // Play the sound
                    const playPromise = clickSound.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('Navigation sound played, waiting before redirect...');
                            
                            // Wait for the sound to play a bit before navigating
                            setTimeout(function() {
                                console.log('Navigating to player selection...');
                                window.location.href = 'playerselection.html';
                            }, 300);
                        }).catch(error => {
                            console.error('Error playing navigation sound:', error);
                            // Navigate anyway if sound fails
                            window.location.href = 'playerselection.html';
                        });
                    } else {
                        // Fallback if play() doesn't return a promise
                        setTimeout(function() {
                            window.location.href = 'playerselection.html';
                        }, 300);
                    }
                });
                
                // If there's an error loading the sound, navigate anyway
                clickSound.addEventListener('error', function() {
                    console.error('Error loading navigation sound');
                    window.location.href = 'playerselection.html';
                });
                
                // Start loading the sound
                clickSound.load();
            } else {
                // If SoundManager is not available, just navigate
                window.location.href = 'playerselection.html';
            }
        }

        // Function to go back to map selection
        function goToMapSelection() {
            console.log('Going back to map selection...');
            
            // Play click sound and navigate after it completes
            if (window.SoundManager) {
                // Create a new audio element specifically for this navigation
                const clickSound = new Audio('../assests/audio/button_click.mp3');
                clickSound.volume = 0.5;
                
                // When the sound can play, play it and set up navigation
                clickSound.addEventListener('canplaythrough', function() {
                    console.log('Navigation sound loaded, playing...');
                    
                    // Play the sound
                    const playPromise = clickSound.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('Navigation sound played, waiting before redirect...');
                            
                            // Wait for the sound to play a bit before navigating
                            setTimeout(function() {
                                console.log('Navigating to map selection...');
                                window.location.href = 'maps.html';
                            }, 300);
                        }).catch(error => {
                            console.error('Error playing navigation sound:', error);
                            // Navigate anyway if sound fails
                            window.location.href = 'maps.html';
                        });
                    } else {
                        // Fallback if play() doesn't return a promise
                        setTimeout(function() {
                            window.location.href = 'maps.html';
                        }, 300);
                    }
                });
                
                // If there's an error loading the sound, navigate anyway
                clickSound.addEventListener('error', function() {
                    console.error('Error loading navigation sound');
                    window.location.href = 'maps.html';
                });
                
                // Start loading the sound
                clickSound.load();
            } else {
                // If SoundManager is not available, just navigate
                window.location.href = 'maps.html';
            }
        }

        function openSettings() {
            // Pause the game
            if (window.gameState) {
                window.gameState.roundPaused = true;
            }
            
            // Stop background music
            const mapMusic = document.getElementById('mapMusic');
            if (mapMusic) {
                mapMusic.pause();
            }
            
            // Show settings overlay
            document.getElementById('settingsOverlay').style.display = 'flex';
        }

        function closeSettings() {
            // Hide settings overlay
            document.getElementById('settingsOverlay').style.display = 'none';
            
            // Resume background music
            const mapMusic = document.getElementById('mapMusic');
            if (mapMusic) {
                mapMusic.play();
            }
            
            // Unpause the game
            if (window.gameState) {
                window.gameState.roundPaused = false;
            }
        }

        function restartGame() {
            sessionStorage.setItem('isReplay', 'true');
            location.reload();
        }

        function goToMainMenu() {
            if (window.SoundManager) {
                window.SoundManager.playClickSound();
            }
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 300);
        }

        function openAudioSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
            document.getElementById('audioSettingsOverlay').style.display = 'flex';
            
            // Load saved volumes
            loadSavedVolumes();
        }

        function closeAudioSettings() {
            document.getElementById('audioSettingsOverlay').style.display = 'none';
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            // Save volumes
            saveVolumes();
        }

        function updateVolume(type, value) {
            // Update the display value
            const slider = document.getElementById(`${type}Volume`);
            const displayValue = slider.nextElementSibling;
            displayValue.textContent = `${value}%`;
            
            const volume = value / 100;

            // Update the actual volume based on type
            switch(type) {
                case 'bgm':
                    const mapMusic = document.getElementById('mapMusic');
                    if (mapMusic) mapMusic.volume = volume;
                    break;
                case 'sfx':
                    // Update SoundManager volume if it exists
                    if (window.SoundManager) {
                        window.SoundManager.setVolume(volume);
                    }
                    break;
                case 'announcer':
                    // Update announcer audio elements
                    if (window.announcer) {
                        Object.values(window.announcer.audioElements).forEach(audio => {
                            if (audio && audio !== window.announcer.audioElements.introCheer) {
                                audio.volume = volume;
                            }
                        });
                    }
                    break;
                case 'playerSfx':
                    // Store the volume for player sound effects
                    window.playerSfxVolume = volume;
                    break;
            }
        }

        function saveVolumes() {
            const volumes = {
                bgm: document.getElementById('bgmVolume').value,
                sfx: document.getElementById('sfxVolume').value,
                announcer: document.getElementById('announcerVolume').value,
                playerSfx: document.getElementById('playerSfxVolume').value
            };
            localStorage.setItem('audioSettings', JSON.stringify(volumes));
        }

        function loadSavedVolumes() {
            const savedVolumes = localStorage.getItem('audioSettings');
            if (savedVolumes) {
                const volumes = JSON.parse(savedVolumes);
                Object.entries(volumes).forEach(([type, value]) => {
                    const slider = document.getElementById(`${type}Volume`);
                    if (slider) {
                        slider.value = value;
                        updateVolume(type, value);
                    }
                });
            }
        }

        // Load saved volumes when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedVolumes();
        });

        // Victory audio elements
        const victoryMusic = new Audio('../assests/audio/announcer/victory.mp3');
        victoryMusic.volume = 0.7;
        const crowdCheer = new Audio('../assests/audio/ambience/cheer2_charecters.mp3');
        crowdCheer.volume = 0.5;

        // Function to create a single particle
        function createParticle(x, y, color) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: 10px;
                height: 10px;
                background: ${color};
                border-radius: 50%;
                pointer-events: none;
                z-index: 1000;
            `;

            // Random direction and speed
            const angle = Math.random() * Math.PI * 2;
            const velocity = 5 + Math.random() * 15;
            const vx = Math.cos(angle) * velocity;
            const vy = Math.sin(angle) * velocity;

            document.body.appendChild(particle);

            let posX = x;
            let posY = y;
            let opacity = 1;
            let scale = 1;

            function animate() {
                if (opacity <= 0) {
                    particle.remove();
                    return;
                }

                posX += vx;
                posY += vy;
                opacity -= 0.02;
                scale -= 0.01;

                particle.style.transform = `translate(${posX - x}px, ${posY - y}px) scale(${scale})`;
                particle.style.opacity = opacity;

                requestAnimationFrame(animate);
            }

            animate();
        }

        // Function to create victory particles
        function createVictoryParticles() {
            const colors = ['#ff0000', '#ff4444', '#ffff00', '#ffffff'];
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // Initial burst
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createParticle(centerX, centerY, colors[Math.floor(Math.random() * colors.length)]);
                }, i * 20);
            }

            // Secondary bursts
            for (let j = 0; j < 3; j++) {
                setTimeout(() => {
                    for (let i = 0; i < 20; i++) {
                        createParticle(centerX, centerY, colors[Math.floor(Math.random() * colors.length)]);
                    }
                }, 1000 + j * 500);
            }
        }

        // Listen for game over event
        window.addEventListener('gameOver', (event) => {
            // Play victory sounds
            if (event.detail.byDecision) {
                // Play special decision victory music
                const decisionMusic = new Audio('../assests/audio/announcer/victory_by_decision.mp3');
                decisionMusic.volume = 0.7;
                decisionMusic.play().catch(e => console.warn('Decision music play failed:', e));
                
                // Create "Victory by Decision" text
                const decisionText = document.createElement('div');
                decisionText.className = 'victory-by-decision';
                decisionText.textContent = 'VICTORY BY DECISION';
                document.body.appendChild(decisionText);
                
                // Remove text after 3 seconds
                setTimeout(() => {
                    decisionText.style.opacity = '0';
                    setTimeout(() => decisionText.remove(), 1000);
                }, 3000);
            } else {
                victoryMusic.play();
            }
            
            // Always play crowd cheer
            crowdCheer.play();

            // Create particle effects with different colors for decision victory
            const colors = event.detail.byDecision 
                ? ['#ffd700', '#ffff00', '#ffffff', '#ffa500'] // Gold theme for decision
                : ['#ff0000', '#ff4444', '#ffff00', '#ffffff']; // Regular victory colors
            
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // Initial burst
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createParticle(centerX, centerY, colors[Math.floor(Math.random() * colors.length)]);
                }, i * 20);
            }

            // Secondary bursts
            for (let j = 0; j < 3; j++) {
                setTimeout(() => {
                    for (let i = 0; i < 20; i++) {
                        createParticle(centerX, centerY, colors[Math.floor(Math.random() * colors.length)]);
                    }
                }, 1000 + j * 500);
            }

            // Show winner announcement with special styling for decision victory
            const announcement = document.createElement('div');
            announcement.className = 'winner-announcement';
            announcement.textContent = `${event.detail.winner} WINS!`;
            if (event.detail.byDecision) {
                announcement.style.color = '#ffd700';
                announcement.style.textShadow = '0 0 20px #ffd700, 0 0 40px #ffd700';
            }
            document.body.appendChild(announcement);

            // Remove announcement after overlay appears
            setTimeout(() => {
                announcement.remove();
            }, 3000);
        });
    </script>
    
    <!-- Add announcer.js before fight.js -->
    <script src="../js/announcer.js"></script>
    <script src="../js/fight.js"></script>
</body>
</html> 